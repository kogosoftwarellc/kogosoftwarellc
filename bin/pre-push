#!/bin/bash

set -e
set -x

function clear_dir() {
  for file in `ls -a`;do
    if [[ "$file" != '.git' && "$file" != '.' && "$file" != '..' ]];then
      rm -rf $file
    fi
  done
}

function clean_working_copy() {
  git clean -fd
}

TMP_DIR="/tmp/github-pages-`date +%s`"

echo "Current directory: $PWD"
echo "Temp directory $TMP_DIR"

clean_working_copy

git pull origin src

npm install

gulp

mv dist ${TMP_DIR}dist

mv node_modules ${TMP_DIR}node_modules

clean_working_copy

git checkout master

clean_working_copy

git pull origin master

clear_dir

cp -R $TMP_DIR/* .

set +x

if [ -n "`git status --porcelain`" ];then
  set -x
  git add -A .
  git commit -m updates
  
  git push origin master
else
  echo 'No updates need to be made!'
fi

set -x

git checkout src

mv ${TMP_DIR}node_modules .
